<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Portal de empleos en Le√≥n, Guanajuato - Encuentra oportunidades laborales">
<title>Empleos Le√≥n GTO - Portal de Vacantes</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíº</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;overflow-x:hidden;color:#1a1a1a}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(50px) scale(0.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
.fade-in{animation:fadeIn .5s ease-out forwards}
.slide-in{animation:slideIn .3s ease-out forwards}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-window{background:white;border-radius:16px;box-shadow:0 25px 80px rgba(0,0,0,.4);max-width:500px;width:100%;overflow:hidden;border:1px solid rgba(255,255,255,.2)}
.modal-header{background:linear-gradient(135deg,#000 0%,#333 100%);color:white;padding:24px;display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px}
.modal-body{padding:28px;line-height:1.6;color:#495057}
.modal-footer{padding:20px 28px;background:#f8f9fa;display:flex;gap:12px;justify-content:flex-end;border-top:1px solid #e9ecef}
.btn{padding:12px 28px;border-radius:10px;font-weight:600;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);border:none;font-size:14px;text-transform:uppercase;letter-spacing:.5px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 14px rgba(102,126,234,.4)}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(102,126,234,.5)}
.btn-cancel{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;box-shadow:0 4px 14px rgba(220,53,69,.3);font-weight:700}
.btn-cancel:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(220,53,69,.4)}
.btn-outline{background:linear-gradient(135deg,white 0%,#f8f9fa 100%);border:2px solid #667eea;color:#667eea}
.btn-outline:hover:not(:disabled){background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
.btn-autofill{background:linear-gradient(135deg,#000 0%,#333 100%);color:#FFD700;box-shadow:0 4px 14px rgba(0,0,0,.4);border:2px solid rgba(255,215,0,.3)}
.btn-autofill:hover:not(:disabled){background:linear-gradient(135deg,#1a1a1a 0%,#444 100%);transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.5)}
.btn-clean{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#667eea;border:2px solid #667eea}
.btn-clean:hover:not(:disabled){background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;transform:translateY(-2px)}
.btn-save{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;box-shadow:0 4px 14px rgba(40,167,69,.3)}
.btn-save:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(40,167,69,.4)}
.input-group{position:relative;margin-bottom:20px}
.input-group input,.input-group textarea,.input-group select{width:100%;padding:14px 16px;border:2px solid #e9ecef;border-radius:10px;font-size:14px;transition:all .2s;font-family:inherit}
.input-group input:focus,.input-group textarea:focus,.input-group select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.1)}
.input-group label{display:block;margin-bottom:8px;font-weight:600;color:#495057;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
.input-icon{position:absolute;right:16px;top:42px;cursor:pointer;color:#6c757d;transition:color .2s;user-select:none}
.input-icon:hover{color:#667eea}
.alert{padding:16px 20px;border-radius:12px;margin-bottom:20px;display:flex;align-items:center;gap:12px;font-size:14px;animation:slideIn .3s ease-out;font-weight:500}
.alert-success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
.alert-error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
.alert-warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
.alert-info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
.vacancy-card{background:white;border-radius:24px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:all .3s cubic-bezier(.4,0,.2,1);border:2px solid transparent}
.vacancy-card:hover{transform:translateY(-8px);box-shadow:0 20px 50px rgba(0,0,0,.2);border-color:rgba(102,126,234,.3)}
.loader{border:4px solid #f3f4f6;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite;margin:20px auto}
.line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ai-chat-modal{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:400px;max-height:600px;z-index:9999;animation:slideUp .4s ease-out;background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4);border:2px solid rgba(0,0,0,.2)}
.ai-chat-header{background:linear-gradient(135deg,#000 0%,#333 100%);color:#FFD700;padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;cursor:move;font-weight:700;font-size:18px;text-shadow:0 0 10px rgba(255,215,0,.7)}
.ai-chat-header h3{margin:0;color:#FFD700}
.ai-chat-header .close-btn{background:rgba(255,255,255,.1);border:none;color:#FFD700;width:32px;height:32px;border-radius:50%;cursor:pointer;transition:all .3s ease;margin-left:12px}
.ai-chat-header .close-btn:hover{background:rgba(255,215,0,.2);transform:rotate(90deg)}
.ai-chat-messages{background:rgba(0,0,0,.95);padding:20px;max-height:300px;overflow-y:auto;border-left:2px solid #FFD700;border-right:2px solid #FFD700}
.ai-message{margin-bottom:16px;padding:12px 16px;border-radius:12px;max-width:90%;word-wrap:break-word;font-size:14px;line-height:1.5}
.ai-message.user{background:linear-gradient(135deg,#2563eb 0%,#3b82f6 100%);color:white;margin-left:auto;border-top-right-radius:4px}
.ai-message.bot{background:linear-gradient(135deg,#1a1a1a 0%,#333 100%);color:#FFD700;border-top-left-radius:4px;border-left:3px solid #FFD700}
.ai-loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,215,0,.3);border-top-color:#FFD700;border-radius:50%;animation:spin 1s linear infinite}
.ai-chat-input{background:linear-gradient(135deg,#000 0%,#333 100%);padding:16px;border-radius:0 0 16px 16px}
.ai-chat-input textarea{width:100%;padding:12px 16px;border:2px solid #FFD700;border-radius:12px;background:rgba(255,255,255,.1);color:white;resize:none;font-family:inherit;font-size:14px;transition:all .3s ease}
.ai-chat-input textarea:focus{outline:none;border-color:#FFD700;box-shadow:0 0 15px rgba(255,215,0,.5)}
.ai-chat-input textarea::placeholder{color:rgba(255,255,255,.5)}
.ai-chat-actions{display:flex;gap:12px;margin-top:12px}
.ai-chat-actions button{flex:1;padding:12px 16px;border:none;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:8px}
.ai-chat-actions .btn-send{background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);color:white}
.ai-chat-actions .btn-send:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(59,130,246,.4)}
.ai-chat-actions .btn-start{background:linear-gradient(135deg,#16a34a 0%,#22c55e 100%);color:white;animation:pulse-gold 2s infinite}
@keyframes pulse-gold{0%,100%{opacity:1}50%{opacity:.5;transform:scale(1.1)}}
.ai-chat-actions .btn-start:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 8px 20px rgba(34,197,94,.4)}
.ai-chat-actions .btn-close-chat{background:linear-gradient(135deg,#dc3545 0%,#e83e8c 100%);color:white}
.ai-chat-actions .btn-close-chat:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(220,53,69,.4)}
.ai-chat-input .file-upload{display:flex;align-items:center;gap:12px;margin-top:12px}
.ai-chat-input .file-upload label{background:rgba(255,215,0,.2);color:#FFD700;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;transition:all .3s ease;border:1px solid rgba(255,215,0,.3)}
.ai-chat-input .file-upload label:hover{background:rgba(255,215,0,.3);transform:translateY(-1px)}
.ai-chat-input .file-upload input{display:none}
.ai-chat-input .file-preview{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);padding:8px 12px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,215,0,.2)}
.ai-chat-input .file-preview img{width:40px;height:40px;object-fit:cover;border-radius:6px}
.ai-chat-input .file-preview .remove-file{background:rgba(255,0,0,.3);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:12px}
.ai-chat-modal.minimized{width:280px;height:60px;max-height:60px}
.ai-chat-modal.minimized .ai-chat-messages,.ai-chat-modal.minimized .ai-chat-input{display:none}
.ai-chat-modal.minimized .ai-chat-header{border-radius:16px}
.ai-chat-modal.minimized .ai-chat-header h3{font-size:14px}
::-webkit-scrollbar{width:12px}
::-webkit-scrollbar-track{background:#f1f1f1}
::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:6px}
@media(max-width:768px){.ai-chat-modal{width:95%;max-width:95%}.modal-window{margin:20px}}
.form-buttons-container{display:flex;flex-direction:column;gap:12px}
@media (min-width:640px){.form-buttons-container{flex-direction:row}}
</style>
</head>
<body>
<div id="app"></div>
<div id="modal-root"></div>
<script>
console.log('üöÄ [INICIO] Cargando aplicaci√≥n Empleos Le√≥n GTO...');
const SUPABASE_URL = 'https://mecrloufrzbfcihioeve.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lY3Jsb3VmcnpiZmNpaGlvZXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTM2OTgsImV4cCI6MjA4NjMyOTY5OH0.Gs36EkNHv5vG2CPdrK7XtCnWvX5NYkyPY9moTdezbVA';
const SUPABASE_REDIRECT_URL = 'https://flavioalejandrov24-lang.github.io/empleosleongto/';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
console.log('‚úÖ [SUPABASE] Cliente inicializado');

// üîß Estado centralizado
let state = {
  view: 'login',
  user: null,
  isGuest: false,
  vacancies: [],
  editingVacancy: null,
  showPassword: false,
  showConfirmPassword: false,
  menuOpen: false,
  acceptedTerms: false,
  loading: false,
  formData: {
    email: '',
    password: '',
    confirmPassword: '',
    company: '',
    job_title: '',
    description: '',
    location: '',
    contact_phone: '',
    contact_email: '',
    schedule: '',
    work_days: '',
    imageUrl: ''
  },
  aiChatOpen: false,
  aiMessages: [],
  aiLoading: false,
  aiImage: null,
  aiImagePreview: null,
  aiExtractedData: null
};

// üîß Variables para drag and drop
let isDragging = false;
let offsetX = 0, offsetY = 0;

// üîß UTILITIES
const showLoading = () => {
  state.loading = true;
  const existingLoader = document.getElementById('loader-overlay');
  if (existingLoader) return;
  
  const loader = document.createElement('div');
  loader.id = 'loader-overlay';
  loader.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
  loader.innerHTML = '<div class="loader"></div>';
  document.body.appendChild(loader);
};

const hideLoading = () => {
  state.loading = false;
  const loader = document.getElementById('loader-overlay');
  if (loader) loader.remove();
};

const showModal = (type, title, message) => {
  const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
  const colors = {
    success: 'linear-gradient(135deg,#28a745 0%,#20c997 100%)',
    error: 'linear-gradient(135deg,#dc3545 0%,#e83e8c 100%)',
    warning: 'linear-gradient(135deg,#ffc107 0%,#fd7e14 100%)',
    info: 'linear-gradient(135deg,#17a2b8 0%,#20c997 100%)'
  };
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-window">
      <div class="modal-header" style="background:${colors[type]}">
        <span style="font-size:28px">${icons[type]}</span>
        <span>${title}</span>
      </div>
      <div class="modal-body"><p>${message}</p></div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
          <i class="fas fa-check"></i> Aceptar
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-root').appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  setTimeout(() => { if (modal.parentNode) modal.remove(); }, 8000);
};

const escapeHtml = (text) => {
  if (typeof text !== 'string') return '';
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text.replace(/[&<>"']/g, m => map[m]);
};

// üîß AUTH FUNCTIONS
async function handleLogin(e) {
  e.preventDefault();
  if (state.loading) return;
  
  showLoading();
  try {
    const email = state.formData.email.trim();
    const password = state.formData.password;
    if (!email || !password) throw new Error('Correo y contrase√±a son requeridos');
    
    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) throw error;
    
    state.user = data.user;
    const accepted = localStorage.getItem('terms_accepted_' + data.user.id);
    state.acceptedTerms = !!accepted;
    state.view = accepted ? 'dashboard' : 'terms';
    
    await loadVacancies();
    render();
    showModal('success', 'Bienvenido', 'Has iniciado sesi√≥n correctamente');
  } catch (error) {
    console.error('‚ùå [LOGIN] Error:', error);
    showModal('error', 'Error de inicio de sesi√≥n', error.message || 'Correo o contrase√±a incorrectos');
  } finally {
    hideLoading();
  }
}

async function handleSignup(e) {
  e.preventDefault();
  if (state.loading) return;
  
  if (state.formData.password !== state.formData.confirmPassword) {
    return showModal('error', 'Error', 'Las contrase√±as no coinciden');
  }
  if (state.formData.password.length < 6) {
    return showModal('error', 'Error', 'La contrase√±a debe tener al menos 6 caracteres');
  }
  
  showLoading();
  try {
    const email = state.formData.email.trim().toLowerCase();
    const { data, error } = await supabaseClient.auth.signUp({
      email,
      password: state.formData.password,
      options: { emailRedirectTo: SUPABASE_REDIRECT_URL }
    });
    if (error) throw error;
    
    showModal('success', 'Registro exitoso', 'Revisa tu correo para confirmar tu cuenta.');
    state.view = 'login';
    resetAuthForm();
    render();
  } catch (error) {
    console.error('‚ùå [SIGNUP] Error:', error);
    showModal('error', 'Error', error.message.includes('already registered') ? 'Este correo ya est√° registrado' : error.message);
  } finally {
    hideLoading();
  }
}

async function handleResetPassword() {
  const email = prompt('Ingresa tu correo electr√≥nico:');
  if (!email) return;
  
  showLoading();
  try {
    const { error } = await supabaseClient.auth.resetPasswordForEmail(email.trim(), { redirectTo: SUPABASE_REDIRECT_URL });
    if (error) throw error;
    showModal('success', 'Correo enviado', 'Revisa tu bandeja de entrada para restablecer tu contrase√±a');
  } catch (error) {
    console.error('‚ùå [RESET] Error:', error);
    showModal('error', 'Error', 'No se pudo enviar el correo');
  } finally {
    hideLoading();
  }
}

async function handleLogout() {
  if (!confirm('¬øCerrar sesi√≥n?')) return;
  
  showLoading();
  try {
    await supabaseClient.auth.signOut();
    state.user = null;
    state.isGuest = false;
    state.view = 'login';
    state.acceptedTerms = false;
    resetAuthForm();
    resetJobForm();
    render();
  } catch (error) {
    console.error('‚ùå [LOGOUT] Error:', error);
  } finally {
    hideLoading();
  }
}

async function handleDeleteAccount() {
  if (!confirm('‚ö†Ô∏è ¬øELIMINAR tu cuenta y TODAS tus vacantes?\nEsta acci√≥n NO se puede deshacer.')) return;
  const conf = prompt('Escribe "ELIMINAR" para confirmar:');
  if (conf !== 'ELIMINAR') return;
  
  showLoading();
  try {
    const { data: userVacancies } = await supabaseClient.from('vacancies').select('id,image_url').eq('user_id', state.user.id);
    if (userVacancies && userVacancies.length > 0) {
      for (const v of userVacancies) {
        if (v.image_url) {
          const path = v.image_url.split('/vacancy-images/')[1];
          if (path) await supabaseClient.storage.from('vacancy-images').remove([path]);
        }
        await supabaseClient.from('vacancies').delete().eq('id', v.id);
      }
    }
    localStorage.removeItem('terms_accepted_' + state.user.id);
    showModal('success', 'Eliminado', 'Tus vacantes han sido eliminadas.');
    setTimeout(() => handleLogout(), 2000);
  } catch (error) {
    console.error('‚ùå [DELETE] Error:', error);
    showModal('error', 'Error', 'No se pudo eliminar');
  } finally {
    hideLoading();
  }
}

function handleGuestAccess() {
  state.isGuest = true;
  state.view = 'dashboard';
  loadVacancies();
  render();
}

function handleAcceptTerms() {
  if (!state.acceptedTerms) return showModal('warning', 'T√©rminos requeridos', 'Debes aceptar los t√©rminos');
  if (state.user) localStorage.setItem('terms_accepted_' + state.user.id, 'true');
  state.view = 'dashboard';
  render();
}

function togglePassword(field) {
  if (field === 'password') state.showPassword = !state.showPassword;
  else state.showConfirmPassword = !state.showConfirmPassword;
  render();
}

// üîß VACANCY FUNCTIONS
async function loadVacancies() {
  try {
    const { data, error } = await supabaseClient.from('vacancies').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    state.vacancies = data || [];
    console.log('‚úÖ [VACANCIES] Loaded:', state.vacancies.length);
  } catch (error) {
    console.error('‚ùå [VACANCIES] Error:', error);
    state.vacancies = [];
  }
}

async function handleImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (file.size > 2 * 1024 * 1024) {
    showModal('error', 'Archivo muy grande', 'M√°ximo 2MB');
    e.target.value = '';
    return;
  }
  if (!file.type.startsWith('image/')) {
    showModal('error', 'Tipo inv√°lido', 'Solo im√°genes');
    e.target.value = '';
    return;
  }
  
  showLoading();
  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `${state.user.id}/${Date.now()}.${fileExt}`;
    const { error: uploadError } = await supabaseClient.storage.from('vacancy-images').upload(fileName, file);
    if (uploadError) throw uploadError;
    
    const { data: urlData } = supabaseClient.storage.from('vacancy-images').getPublicUrl(fileName);
    state.formData.imageUrl = urlData.publicUrl;
    console.log('‚úÖ [UPLOAD] Image URL:', state.formData.imageUrl);
    render();
  } catch (error) {
    console.error('‚ùå [UPLOAD] Error:', error);
    showModal('error', 'Error al subir', error.message);
    e.target.value = '';
  } finally {
    hideLoading();
  }
}

async function handleSaveVacancy(e) {
  e.preventDefault();
  
  // Validaciones
  if (!state.formData.company || !state.formData.job_title || !state.formData.description) {
    return showModal('error', 'Campos requeridos', 'Completa empresa, puesto y descripci√≥n');
  }
  if (!state.formData.imageUrl) {
    return showModal('error', 'Imagen requerida', 'Sube una imagen');
  }
  if (state.formData.contact_phone) {
    const phoneDigits = state.formData.contact_phone.replace(/\D/g, '');
    if (phoneDigits.length < 10 || phoneDigits.length > 16) {
      return showModal('error', 'Tel√©fono inv√°lido', '10-16 d√≠gitos');
    }
  }

  // Prevenir m√∫ltiples env√≠os
  if (state.loading) return;

  showLoading();

  try {
    const vacancyData = {
      user_id: state.user.id,
      company: state.formData.company.trim(),
      job_title: state.formData.job_title.trim(),
      description: state.formData.description.trim(),
      location: state.formData.location.trim() || 'Le√≥n, Guanajuato',
      contact_phone: state.formData.contact_phone.replace(/\D/g, ''),
      contact_email: state.formData.contact_email.trim(),
      schedule: state.formData.schedule.trim(),
      work_days: state.formData.work_days.trim(),
      image_url: state.formData.imageUrl
    };

    let result;
    if (state.editingVacancy) {
      result = await supabaseClient.from('vacancies').update(vacancyData).eq('id', state.editingVacancy.id);
      console.log('‚úÖ [UPDATE] Vacancy updated');
    } else {
      result = await supabaseClient.from('vacancies').insert([vacancyData]);
      console.log('‚úÖ [INSERT] Vacancy created');
    }

    if (result.error) throw result.error;

    // Limpiar estado
    const wasEditing = !!state.editingVacancy;
    state.editingVacancy = null;
    resetJobForm();
    state.aiImage = null;
    state.aiImagePreview = null;
    state.aiExtractedData = null;
    state.aiMessages = [];
    state.aiChatOpen = false;

    // Recargar vacantes y cambiar vista
    await loadVacancies();
    state.view = 'dashboard';
    
    hideLoading();
    render();
    
    showModal('success', '¬°√âxito!', wasEditing ? 'Vacante actualizada' : 'Vacante publicada');
    
  } catch (error) {
    console.error('‚ùå [SAVE] Error:', error);
    hideLoading();
    showModal('error', 'Error', error.message || 'No se pudo guardar');
  }
}

async function handleDeleteVacancy(vacancy) {
  if (!confirm(`¬øEliminar vacante de ${vacancy.company}?`)) return;
  
  showLoading();
  try {
    if (vacancy.image_url) {
      const path = vacancy.image_url.split('/vacancy-images/')[1];
      if (path) await supabaseClient.storage.from('vacancy-images').remove([path]);
    }
    const { error } = await supabaseClient.from('vacancies').delete().eq('id', vacancy.id);
    if (error) throw error;
    
    await loadVacancies();
    render();
    showModal('success', 'Eliminado', 'Vacante eliminada correctamente');
  } catch (error) {
    console.error('‚ùå [DELETE] Error:', error);
    showModal('error', 'Error', 'No se pudo eliminar');
  } finally {
    hideLoading();
  }
}

function handleEditVacancy(vacancy) {
  state.editingVacancy = vacancy;
  state.formData = {
    company: vacancy.company || '',
    job_title: vacancy.job_title || '',
    description: vacancy.description || '',
    location: vacancy.location || '',
    contact_phone: vacancy.contact_phone || '',
    contact_email: vacancy.contact_email || '',
    schedule: vacancy.schedule || '',
    work_days: vacancy.work_days || '',
    imageUrl: vacancy.image_url || '',
    email: '',
    password: '',
    confirmPassword: ''
  };
  state.view = 'form';
  render();
}

// üîß AI FUNCTIONS
function toggleAIChat() {
  state.aiChatOpen = !state.aiChatOpen;
  if (state.aiChatOpen && state.aiMessages.length === 0) {
    state.aiMessages = [{
      role: 'bot',
      content: '¬°Hola! Puedes enviarme una imagen con informaci√≥n de la vacante o describirme los detalles, y yo te ayudo a llenar el formulario autom√°ticamente.'
    }];
  }
  render();
}

async function sendAIMessage() {
  const input = document.getElementById('ai-chat-input');
  const message = input?.value.trim();
  
  if (!message && !state.aiImage) {
    showModal('info', 'Mensaje vac√≠o', 'Escribe algo o sube una imagen');
    return;
  }

  if (message) {
    state.aiMessages.push({ role: 'user', content: message });
  }

  state.aiLoading = true;
  render();

  try {
    // Simulaci√≥n de IA (reemplaza esto con tu Edge Function real)
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // Extraer datos del mensaje o imagen
    const extractedData = extractVacancyData(message);
    
    if (extractedData) {
      state.aiExtractedData = extractedData;
      state.aiMessages.push({
        role: 'bot',
        content: '¬°Perfecto! He extra√≠do la informaci√≥n. Presiona el bot√≥n "START" para rellenar el formulario autom√°ticamente.'
      });
    } else {
      state.aiMessages.push({
        role: 'bot',
        content: 'He procesado tu informaci√≥n. Presiona "START" para aplicar los cambios al formulario.'
      });
    }
    
  } catch (error) {
    console.error('‚ùå [IA] Error:', error);
    state.aiMessages.push({
      role: 'bot',
      content: `Error: ${error.message}. Por favor intenta de nuevo.`
    });
  } finally {
    state.aiLoading = false;
    if (input) input.value = '';
    state.aiImage = null;
    state.aiImagePreview = null;
    render();
    
    // Auto-scroll al √∫ltimo mensaje
    setTimeout(() => {
      const messagesContainer = document.querySelector('.ai-chat-messages');
      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }, 100);
  }
}

// Funci√≥n auxiliar para extraer datos (mejora esto seg√∫n tus necesidades)
function extractVacancyData(text) {
  if (!text) return null;
  
  const data = {};
  const lowerText = text.toLowerCase();
  
  // Intentar extraer empresa
  if (lowerText.includes('empresa:')) {
    const match = text.match(/empresa:\s*([^\n]+)/i);
    if (match) data.company = match[1].trim();
  }
  
  // Intentar extraer puesto
  if (lowerText.includes('puesto:') || lowerText.includes('vacante:')) {
    const match = text.match(/(?:puesto|vacante):\s*([^\n]+)/i);
    if (match) data.job_title = match[1].trim();
  }
  
  // Intentar extraer descripci√≥n
  if (lowerText.includes('descripci√≥n:') || lowerText.includes('descripcion:')) {
    const match = text.match(/descripci[o√≥]n:\s*([^\n]+)/i);
    if (match) data.description = match[1].trim();
  }
  
  // Intentar extraer tel√©fono
  const phoneMatch = text.match(/(?:tel[e√©]fono|whatsapp|tel|wa):\s*(\d{10,})/i);
  if (phoneMatch) data.contact_phone = phoneMatch[1];
  
  // Intentar extraer email
  const emailMatch = text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/);
  if (emailMatch) data.contact_email = emailMatch[1];
  
  return Object.keys(data).length > 0 ? data : null;
}

function startAutofill() {
  if (!state.aiExtractedData) {
    showModal('info', 'Sin datos', 'Primero env√≠a informaci√≥n para procesar.');
    return;
  }
  
  const data = state.aiExtractedData;
  if (data.company) state.formData.company = data.company;
  if (data.job_title) state.formData.job_title = data.job_title;
  if (data.description) state.formData.description = data.description;
  if (data.location) state.formData.location = data.location;
  if (data.contact_phone) state.formData.contact_phone = data.contact_phone;
  if (data.contact_email) state.formData.contact_email = data.contact_email;
  if (data.schedule) state.formData.schedule = data.schedule;
  if (data.work_days) state.formData.work_days = data.work_days;
  
  state.aiChatOpen = false;
  state.aiMessages = [];
  state.aiExtractedData = null;
  
  render();
  showModal('success', '¬°Formulario rellenado!', 'Revisa los campos y ajusta si es necesario.');
}

function handleAIImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 10 * 1024 * 1024) {
    showModal('error', 'Archivo Grande', 'M√°ximo 10MB');
    return;
  }
  
  state.aiImage = file;
  const reader = new FileReader();
  reader.onload = (e) => {
    state.aiImagePreview = e.target.result;
    render();
  };
  reader.readAsDataURL(file);
}

function removeAIImage() {
  state.aiImage = null;
  state.aiImagePreview = null;
  render();
}

function toggleChatMinimize() {
  const chat = document.querySelector('.ai-chat-modal');
  if (chat) chat.classList.toggle('minimized');
}

function startDrag(e) {
  isDragging = true;
  const chat = document.querySelector('.ai-chat-modal');
  if (!chat) return;
  const rect = chat.getBoundingClientRect();
  offsetX = e.clientX - rect.left;
  offsetY = e.clientY - rect.top;
  chat.style.transition = 'none';
}

function drag(e) {
  if (!isDragging) return;
  const chat = document.querySelector('.ai-chat-modal');
  if (!chat) return;
  const x = e.clientX - offsetX;
  const y = e.clientY - offsetY;
  const maxX = window.innerWidth - chat.offsetWidth;
  const maxY = window.innerHeight - chat.offsetHeight;
  chat.style.left = `${Math.max(0, Math.min(x, maxX))}px`;
  chat.style.top = `${Math.max(0, Math.min(y, maxY))}px`;
  chat.style.transform = 'none';
}

function stopDrag() {
  if (isDragging) {
    isDragging = false;
    const chat = document.querySelector('.ai-chat-modal');
    if (chat) chat.style.transition = 'all 0.3s ease';
  }
}

document.addEventListener('mousemove', drag);
document.addEventListener('mouseup', stopDrag);

// üîß FORM UTILITIES
function cleanForm() {
  resetJobForm();
  render();
  showModal('info', 'Formulario Limpiado', 'Todos los campos han sido vaciados');
}

function cancelForm() {
  state.editingVacancy = null;
  state.view = 'dashboard';
  resetJobForm();
  render();
}

function resetAuthForm() {
  state.formData.email = '';
  state.formData.password = '';
  state.formData.confirmPassword = '';
}

function resetJobForm() {
  state.formData.company = '';
  state.formData.job_title = '';
  state.formData.description = '';
  state.formData.location = '';
  state.formData.contact_phone = '';
  state.formData.contact_email = '';
  state.formData.schedule = '';
  state.formData.work_days = '';
  state.formData.imageUrl = '';
}

// üîß RENDER FUNCTIONS
function renderLogin() {
return `
<div class="min-h-screen flex items-center justify-center p-4">
<div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden fade-in">
<div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white text-center">
<div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-xl">
<svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
</svg>
</div>
<h1 class="text-3xl font-black mb-2">Portal de Empleos</h1>
<p class="text-purple-200 text-sm font-semibold">Le√≥n, Guanajuato</p>
</div>
<div class="p-8">
<form onsubmit="handleLogin(event)">
<div class="input-group">
<label>Correo Electr√≥nico</label>
<input type="email" name="email" required placeholder="tu@email.com" value="${escapeHtml(state.formData.email)}" oninput="state.formData.email=this.value">
</div>
<div class="input-group">
<label>Contrase√±a</label>
<input type="${state.showPassword ? 'text' : 'password'}" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="${escapeHtml(state.formData.password)}" oninput="state.formData.password=this.value">
<span class="input-icon" onclick="togglePassword('password')">${state.showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
</div>
<div class="text-right mb-6">
<a href="#" class="text-purple-600 text-sm font-semibold hover:underline" onclick="handleResetPassword();return false">
¬øOlvidaste tu contrase√±a?
</a>
</div>
<button type="submit" class="btn btn-primary w-full mb-3" ${state.loading ? 'disabled' : ''}>
${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Ingresando...' : '<i class="fas fa-sign-in-alt"></i> Ingresar'}
</button>
<button type="button" class="btn btn-outline w-full mb-3" onclick="handleGuestAccess()">
<i class="fas fa-eye"></i> Ver Empleos P√∫blicos
</button>
<div class="text-center mt-6">
<p class="text-gray-600 text-sm mb-2">¬øNo tienes cuenta?</p>
<button type="button" class="text-purple-600 font-semibold hover:underline" onclick="state.view='signup';render()">
Crear cuenta nueva
</button>
</div>
</form>
</div>
</div>
</div>
`;
}

function renderSignup() {
return `
<div class="min-h-screen flex items-center justify-center p-4">
<div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden fade-in">
<div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white text-center">
<h1 class="text-3xl font-black mb-2">Crear Cuenta</h1>
<p class="text-purple-200 text-sm">√önete a nuestra comunidad</p>
</div>
<div class="p-8">
<form onsubmit="handleSignup(event)">
<div class="input-group">
<label>Correo Electr√≥nico</label>
<input type="email" required placeholder="tu@email.com" value="${escapeHtml(state.formData.email)}" oninput="state.formData.email=this.value">
</div>
<div class="input-group">
<label>Contrase√±a</label>
<input type="${state.showPassword ? 'text' : 'password'}" name="password" required placeholder="M√≠nimo 6 caracteres" value="${escapeHtml(state.formData.password)}" oninput="state.formData.password=this.value">
<span class="input-icon" onclick="togglePassword('password')">${state.showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
</div>
<div class="input-group">
<label>Confirmar Contrase√±a</label>
<input type="${state.showConfirmPassword ? 'text' : 'password'}" name="confirmPassword" required placeholder="Repite tu contrase√±a" value="${escapeHtml(state.formData.confirmPassword)}" oninput="state.formData.confirmPassword=this.value">
<span class="input-icon" onclick="togglePassword('confirmPassword')">${state.showConfirmPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
</div>
<button type="submit" class="btn btn-primary w-full mb-3" ${state.loading ? 'disabled' : ''}>
${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Creando...' : '<i class="fas fa-user-plus"></i> Crear Cuenta'}
</button>
<button type="button" class="btn btn-cancel w-full" onclick="state.view='login';resetAuthForm();render()">
<i class="fas fa-times"></i> Cancelar
</button>
<div class="text-center mt-6">
<p class="text-gray-600 text-sm">
¬øYa tienes cuenta? <a href="#" class="text-purple-600 font-semibold hover:underline" onclick="state.view='login';render();return false">
Inicia sesi√≥n
</a>
</p>
</div>
</form>
</div>
</div>
</div>
`;
}

function renderTerms() {
return `
<div class="min-h-screen flex items-center justify-center p-4">
<div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full overflow-hidden fade-in">
<div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white">
<div class="flex items-center gap-4">
<div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
</svg>
</div>
<div>
<h1 class="text-3xl font-black">T√©rminos y Condiciones</h1>
<p class="text-purple-200 text-sm mt-1">Por favor lee cuidadosamente</p>
</div>
</div>
</div>
<div class="p-8">
<div class="h-96 overflow-y-auto bg-purple-50 p-6 rounded-2xl text-gray-700 text-sm mb-6 leading-relaxed border-2 border-purple-100">
<h3 class="font-black text-purple-900 mb-4 text-lg">‚ö†Ô∏è AVISO A LA COMUNIDAD</h3>
<p class="mb-4"><strong>Le√≥n Vacantes</strong> es un canal comunitario para difundir oportunidades laborales en Le√≥n, GTO.</p>
<p class="mb-4 font-bold text-purple-800">NO nos hacemos responsables por:</p>
<ul class="list-disc pl-6 mb-4 space-y-2">
<li>La veracidad de las ofertas</li>
<li>Condiciones de trabajo</li>
<li>Legalidad de empresas</li>
<li>Cualquier da√±o derivado del uso</li>
</ul>
<p class="mb-4 font-bold text-red-600">üö® RECOMENDACIONES:</p>
<ul class="list-disc pl-6 mb-4 space-y-2">
<li>NUNCA compartas datos bancarios</li>
<li>NO pagues por contrataci√≥n</li>
<li>Entrevistas en lugares p√∫blicos</li>
<li>Verifica autenticidad</li>
<li>Informa a familiares</li>
</ul>
<p class="font-bold text-purple-900">Al usar esta app, aceptas que es bajo tu propio riesgo.</p>
</div>
<div class="flex items-start gap-4 mb-6 bg-purple-50 p-5 rounded-2xl border-2 border-purple-200">
<input type="checkbox" id="accept-terms" class="mt-1 w-6 h-6 rounded border-purple-300 text-purple-600 cursor-pointer" ${state.acceptedTerms ? 'checked' : ''} onchange="state.acceptedTerms=this.checked;render()">
<label for="accept-terms" class="text-sm font-semibold text-gray-700 cursor-pointer select-none">
He le√≠do y acepto los t√©rminos
</label>
</div>
<button onclick="handleAcceptTerms()" class="btn btn-primary w-full" ${!state.acceptedTerms ? 'disabled' : ''}>
<i class="fas fa-check"></i> Comenzar
</button>
</div>
</div>
</div>
`;
}

function renderDashboard() {
return `
<div class="min-h-screen">
<header class="bg-white shadow-lg sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
<div class="flex items-center gap-4">
<div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl flex items-center justify-center shadow-lg">
<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
</svg>
</div>
<div>
<h1 class="text-xl font-black text-gray-800">Portal de Empleos</h1>
<p class="text-xs text-gray-500 font-semibold">Le√≥n, Guanajuato</p>
</div>
</div>
${!state.isGuest ? `
<div class="flex items-center gap-3">
<button onclick="state.view='form';render()" class="btn btn-primary flex items-center gap-2">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
</svg>
<span class="hidden sm:inline">Nueva</span>
</button>
<div class="relative">
<button onclick="state.menuOpen=!state.menuOpen;render()" class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 hover:bg-purple-200">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
</svg>
</button>
${state.menuOpen ? `
<div class="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl border overflow-hidden slide-in">
<div class="p-4 bg-gradient-to-r from-purple-600 to-purple-800 text-white">
<p class="font-semibold text-sm truncate">${escapeHtml(state.user?.email || '')}</p>
</div>
<button onclick="handleLogout()" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 text-sm text-gray-700">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
</svg>
Cerrar Sesi√≥n
</button>
<button onclick="handleDeleteAccount();state.menuOpen=false;render()" class="w-full px-4 py-3 text-left hover:bg-red-50 flex items-center gap-3 text-sm text-red-600 border-t">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
</svg>
Eliminar Cuenta
</button>
</div>
` : ''}
</div>
</div>
` : `
<button onclick="state.view='login';state.isGuest=false;render()" class="btn btn-primary">
<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
</button>
`}
</div>
</header>
${!state.isGuest && state.user ? `
<div class="max-w-7xl mx-auto px-4 mt-6">
<div class="alert alert-warning">
<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
<div><strong>Recordatorio:</strong> Solo puedes editar/eliminar tus vacantes.</div>
</div>
</div>
` : ''}
${state.isGuest ? `
<div class="max-w-7xl mx-auto px-4 mt-6">
<div class="alert alert-info">
<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
<div><strong>Modo invitado:</strong> Inicia sesi√≥n para publicar.</div>
</div>
</div>
` : ''}
<main class="max-w-7xl mx-auto px-4 py-8">
<div class="mb-8">
<h2 class="text-4xl font-black text-white mb-2">Vacantes Disponibles</h2>
<p class="text-purple-200 font-semibold">${state.vacancies.length} oportunidad${state.vacancies.length !== 1 ? 'es' : ''}</p>
</div>
${state.vacancies.length > 0 ? `
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
${state.vacancies.map(v => renderVacancyCard(v)).join('')}
</div>
` : `
<div class="text-center py-20">
<div class="w-32 h-32 bg-white rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-2xl">
<svg class="w-20 h-20 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
</svg>
</div>
<h3 class="text-2xl font-black text-white mb-2">No hay vacantes</h3>
<p class="text-purple-200">S√© el primero en publicar</p>
</div>
`}
</main>
</div>
`;
}

function renderVacancyCard(vacancy) {
const isOwner = state.user && state.user.id === vacancy.user_id;
const vacancyJson = JSON.stringify(vacancy).replace(/"/g, '&quot;');
return `
<div class="vacancy-card fade-in">
<div class="h-56 bg-gradient-to-br from-purple-400 to-purple-600 relative overflow-hidden">
${vacancy.image_url ? `
<img src="${escapeHtml(vacancy.image_url)}" class="w-full h-full object-cover" alt="${escapeHtml(vacancy.company)}">
` : `
<div class="w-full h-full flex items-center justify-center">
<svg class="w-24 h-24 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
</svg>
</div>
`}
<div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent"></div>
<div class="absolute bottom-4 left-4 right-4 text-white">
<h3 class="text-2xl font-bold mb-1 truncate">${escapeHtml(vacancy.company)}</h3>
<p class="text-purple-200 text-xs font-semibold uppercase truncate">${escapeHtml(vacancy.job_title)}</p>
</div>
${isOwner ? `
<div class="absolute top-4 right-4 flex gap-2">
<button onclick='handleEditVacancy(${vacancyJson})' class="w-10 h-10 bg-white/90 rounded-full flex items-center justify-center text-purple-600 hover:bg-purple-600 hover:text-white transition-all shadow-xl">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
</svg>
</button>
<button onclick='handleDeleteVacancy(${vacancyJson})' class="w-10 h-10 bg-white/90 rounded-full flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all shadow-xl">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
</svg>
</button>
</div>
` : ''}
</div>
<div class="p-6 space-y-4">
<p class="text-gray-600 text-sm leading-relaxed line-clamp-3">${escapeHtml(vacancy.description || 'Sin descripci√≥n')}</p>
<div class="space-y-2">
<div class="flex items-center gap-2 text-sm text-gray-600">
<svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
</svg>
<span class="font-medium">${escapeHtml(vacancy.location || 'Le√≥n, GTO')}</span>
</div>
${vacancy.work_days ? `
<div class="flex items-center gap-2 text-sm text-gray-600">
<svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
</svg>
<span class="font-medium">${escapeHtml(vacancy.work_days)}</span>
</div>
` : ''}
${vacancy.schedule ? `
<div class="flex items-center gap-2 text-sm text-gray-600">
<svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
<span class="font-medium">${escapeHtml(vacancy.schedule)}</span>
</div>
` : ''}
</div>
<div class="flex gap-3 pt-2">
${vacancy.contact_phone ? `
<a href="https://wa.me/52${vacancy.contact_phone.replace(/\D/g, '')}" target="_blank" rel="noopener noreferrer" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 px-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:shadow-lg transition-all">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
</svg>
WhatsApp
</a>
` : ''}
${vacancy.contact_email ? `
<a href="mailto:${escapeHtml(vacancy.contact_email)}" class="flex-1 bg-white border-2 border-purple-600 text-purple-600 py-3 px-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-purple-50 transition-all">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
</svg>
Email
</a>
` : ''}
</div>
</div>
</div>
`;
}

function renderForm() {
return `
<div class="min-h-screen py-8">
<div class="max-w-3xl mx-auto px-4">
<div class="bg-white rounded-3xl shadow-2xl overflow-hidden fade-in">
<div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white">
<h2 class="text-3xl font-black mb-2">${state.editingVacancy ? 'Editar Vacante' : 'Nueva Vacante'}</h2>
<p class="text-purple-200">Completa la informaci√≥n</p>
</div>
<form onsubmit="handleSaveVacancy(event)" class="p-8 space-y-6">
<div class="input-group">
<label>Imagen *</label>
<div class="border-2 border-dashed border-purple-300 rounded-xl p-6 text-center hover:border-purple-500 transition-colors cursor-pointer bg-purple-50">
<input type="file" accept="image/*" onchange="handleImageUpload(event)" class="hidden" id="image-upload">
<label for="image-upload" class="cursor-pointer block">
${state.formData.imageUrl ? `
<img src="${escapeHtml(state.formData.imageUrl)}" class="max-h-48 mx-auto rounded-xl shadow-lg mb-3">
<p class="text-sm text-purple-600 font-semibold">Clic para cambiar</p>
` : `
<svg class="w-16 h-16 mx-auto text-purple-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
</svg>
<p class="text-sm text-purple-600 font-semibold">Subir imagen</p>
<p class="text-xs text-gray-500 mt-1">M√°x 2MB</p>
`}
</label>
</div>
</div>
<div class="input-group">
<label>Empresa *</label>
<input type="text" required placeholder="Ej: Calzado Le√≥n" value="${escapeHtml(state.formData.company)}" oninput="state.formData.company=this.value">
</div>
<div class="input-group">
<label>Puesto *</label>
<input type="text" required placeholder="Ej: Desarrollador" value="${escapeHtml(state.formData.job_title)}" oninput="state.formData.job_title=this.value">
</div>
<div class="input-group">
<label>Descripci√≥n *</label>
<textarea rows="5" required placeholder="Describe el puesto..." oninput="state.formData.description=this.value">${escapeHtml(state.formData.description)}</textarea>
</div>
<div class="input-group">
<label>Ubicaci√≥n</label>
<input type="text" placeholder="Le√≥n, GTO" value="${escapeHtml(state.formData.location)}" oninput="state.formData.location=this.value">
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="input-group">
<label>WhatsApp</label>
<input type="tel" maxlength="16" placeholder="4771234567" value="${escapeHtml(state.formData.contact_phone)}" oninput="state.formData.contact_phone=this.value.replace(/\\D/g,'')">
</div>
<div class="input-group">
<label>Email</label>
<input type="email" placeholder="rh@empresa.com" value="${escapeHtml(state.formData.contact_email)}" oninput="state.formData.contact_email=this.value">
</div>
</div>
<div class="input-group">
<label>D√≠as de trabajo</label>
<textarea rows="2" placeholder="Ej: Lunes a Viernes" oninput="state.formData.work_days=this.value">${escapeHtml(state.formData.work_days)}</textarea>
</div>
<div class="input-group">
<label>Horario</label>
<textarea rows="2" placeholder="Ej: 09:00 - 18:00" oninput="state.formData.schedule=this.value">${escapeHtml(state.formData.schedule)}</textarea>
</div>
<div class="form-buttons-container pt-4">
<button type="button" onclick="cancelForm()" class="btn btn-cancel w-full sm:flex-1">
<i class="fas fa-times"></i> Cancelar
</button>
<button type="button" onclick="cleanForm()" class="btn btn-clean w-full sm:flex-1">
<i class="fas fa-eraser"></i> Limpiar
</button>
<button type="button" onclick="toggleAIChat()" class="btn btn-autofill w-full sm:flex-1">
<i class="fas fa-robot"></i> Autofill IA
</button>
<button type="submit" class="btn btn-save w-full sm:flex-1" ${state.loading ? 'disabled' : ''}>
${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Guardando...' : (state.editingVacancy ? '<i class="fas fa-edit"></i> Actualizar' : '<i class="fas fa-save"></i> Publicar')}
</button>
</div>
</form>
</div>
</div>
${state.aiChatOpen ? renderAIChat() : ''}
</div>
`;
}

function renderAIChat() {
return `
<div class="ai-chat-modal" onmousedown="startDrag(event)">
<div class="ai-chat-header">
<h3><i class="fas fa-robot mr-2"></i>Autofill IA</h3>
<div class="flex items-center gap-2">
<button class="close-btn" onclick="toggleChatMinimize()" title="Minimizar">
<i class="fas fa-minus"></i>
</button>
<button class="close-btn" onclick="state.aiChatOpen=false;render()" title="Cerrar">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div class="ai-chat-messages">
${state.aiMessages.map(msg => `
<div class="ai-message ${msg.role}">
${escapeHtml(msg.content)}
</div>
`).join('')}
${state.aiLoading ? `
<div class="ai-message bot">
<span class="ai-loading"></span> Procesando...
</div>
` : ''}
</div>
<div class="ai-chat-input">
<div class="file-upload">
<label>
<i class="fas fa-paperclip mr-1"></i> Imagen
<input type="file" accept="image/*" onchange="handleAIImageUpload(event)" />
</label>
${state.aiImagePreview ? `
<div class="file-preview">
<img src="${escapeHtml(state.aiImagePreview)}" alt="Preview" />
<button class="remove-file" onclick="removeAIImage()">√ó</button>
</div>
` : ''}
</div>
<textarea id="ai-chat-input" placeholder="Describe la vacante o sube una imagen..." rows="3" onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAIMessage();}"></textarea>
<div class="ai-chat-actions">
<button class="btn-send" onclick="sendAIMessage()">
<i class="fas fa-paper-plane"></i> Enviar
</button>
<button class="btn-start" onclick="startAutofill()">
<i class="fas fa-play"></i> START
</button>
<button class="btn-close-chat" onclick="state.aiChatOpen=false;render()">
<i class="fas fa-times"></i> Cerrar
</button>
</div>
</div>
</div>
`;
}

function render() {
  const app = document.getElementById('app');
  if (!app) return;
  
  if (state.menuOpen && state.view !== 'dashboard') state.menuOpen = false;
  
  let content = '';
  switch (state.view) {
    case 'login': content = renderLogin(); break;
    case 'signup': content = renderSignup(); break;
    case 'terms': content = renderTerms(); break;
    case 'dashboard': content = renderDashboard(); break;
    case 'form': content = renderForm(); break;
    default: content = renderLogin();
  }
  
  app.innerHTML = content;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// üîß INITIALIZATION
async function init() {
  console.log('üöÄ [INIT] Inicializando aplicaci√≥n...');
  
  try {
    const { data, error } = await supabaseClient.auth.getSession();
    if (error) throw error;
    
    if (data.session) {
      state.user = data.session.user;
      const accepted = localStorage.getItem('terms_accepted_' + data.session.user.id);
      state.acceptedTerms = !!accepted;
      state.view = accepted ? 'dashboard' : 'terms';
      await loadVacancies();
    }
    
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      console.log('üîê [AUTH] Evento:', event);
      if (event === 'SIGNED_IN' && session) {
        state.user = session.user;
        const accepted = localStorage.getItem('terms_accepted_' + session.user.id);
        state.acceptedTerms = !!accepted;
        state.view = accepted ? 'dashboard' : 'terms';
        await loadVacancies();
        render();
      } else if (event === 'SIGNED_OUT') {
        state.user = null;
        state.view = 'login';
        state.vacancies = [];
        render();
      }
    });
    
    supabaseClient.channel('vacancies-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'vacancies' }, async (payload) => {
        console.log('üì° [REALTIME] Cambio detectado:', payload.eventType);
        await loadVacancies();
        if (state.view === 'dashboard') {
          render();
        }
      })
      .subscribe();
    
    render();
    console.log('‚úÖ [INIT] Aplicaci√≥n inicializada correctamente');
    
  } catch (error) {
    console.error('‚ùå [INIT] Error:', error);
    render();
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
